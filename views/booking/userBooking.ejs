<% layout("/layouts/boilerplate.ejs") %>

<style>
  .booking-card { border: 0; border-radius: 18px; overflow: hidden; transition: .2s ease; }
  .booking-card:hover { transform: translateY(-4px); box-shadow: 0 12px 26px rgba(0,0,0,.08); }
  .status-badge { font-size: .75rem; padding: .35rem .6rem; border-radius: 999px; }
  .status-upcoming { background: #e6f4ff; color: #0a66c2; }
  .status-ongoing  { background: #e8fff3; color: #0b8b50; }
  .status-past     { background: #fff0f0; color: #c24130; }
</style>

<div class="container my-5">
  <h1 class="text-center mb-4 fw-bold">üõéÔ∏è My Bookings</h1>

  <% if (bookings.length === 0) { %>
    <div class="alert alert-info text-center">You have no bookings yet.</div>
  <% } else { %>
    <div class="row g-4">
      <% bookings.forEach(booking => { 
           const s = new Date(booking.startDate);
           const e = new Date(booking.endDate);
           const now = new Date();

           let statusClass = "status-upcoming";
           let statusText  = "Upcoming";
           if (e.getTime() < now.getTime()) { statusClass = "status-past"; statusText="Past"; }
           else if (s.getTime() <= now.getTime() && e.getTime() >= now.getTime()) { statusClass="status-ongoing"; statusText="Ongoing"; }

           const nights = Math.round((e - s) / 86400000);
        %>
        <div class="col-md-6 col-lg-4">
          <div class="card booking-card shadow-sm h-100">
            <img src="<%= booking.listing.image.url %>" class="card-img-top" alt="<%= booking.listing.title %>">
            <div class="card-body d-flex flex-column">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h5 class="card-title mb-0"><%= booking.listing.title %></h5>
                <span class="status-badge <%= statusClass %>"><%= statusText %></span>
              </div>

              <p class="mb-2 text-muted"><i class="fa-solid fa-location-dot me-1"></i>
                <%= booking.listing.location %>, <%= booking.listing.country %>
              </p>

              <div class="mb-2">
                <div><i class="fa-solid fa-calendar-day me-1"></i><strong>From:</strong> <%= s.toDateString() %></div>
                <div><i class="fa-solid fa-calendar-day me-1"></i><strong>To:</strong> <%= e.toDateString() %></div>
                <div><i class="fa-solid fa-moon me-1"></i><strong>Nights:</strong> <%= nights %></div>
              </div>

              <div class="d-flex justify-content-between align-items-center mt-auto">
                <div class="fw-bold fs-6">
                  <i class="fa-solid fa-indian-rupee-sign"></i>
                  <%= new Intl.NumberFormat("en-IN").format(booking.totalPrice) %>
                </div>
                <div class="d-flex gap-2">
                  <a href="/listings/<%= booking.listing._id %>" class="btn btn-outline-primary btn-sm">
                    <i class="fa-solid fa-eye"></i>
                  </a>
                  <form action="/bookings/<%= booking._id %>?_method=DELETE" method="POST"
                        onsubmit="return confirm('Cancel this booking?');">
                    <button class="btn btn-danger btn-sm" <%= (statusText!=="Upcoming") ? "disabled" : "" %>>
                      <i class="fa-solid fa-xmark"></i>
                    </button>
                  </form>
                </div>
              </div>

            </div>
          </div>
        </div>
      <% }) %>
    </div>
  <% } %>
</div>
